{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container">
  <h1>{{ work.title }}</h1>
  <p>–¢–∏–ø: {{ work.get_type_display }}{% if work.genre %}, –ñ–∞–Ω—Ä: {{ work.genre }}{% endif %}</p>
  <p>–†–µ–π—Ç–∏–Ω–≥: {{ work.rating }}/10</p>

  <section class="reviews">
    <h2>–†–µ—Ü–µ–Ω–∑–∏–∏</h2>

    {% if user.is_authenticated %}
      <form action="" method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </form>
    {% else %}
      <p><a href="{% url 'login' %}">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å —Ä–µ—Ü–µ–Ω–∑–∏—é.</p>
    {% endif %}

    <hr>

    {% for review in reviews %}
      <div class="review" data-review-id="{{ review.id }}">
        <p>{{ review.text }}</p>
        <p>–ê–≤—Ç–æ—Ä: {{ review.user.username }}</p>
        <p>
          –ì–æ–ª–æ—Å–∞:
          <span class="vote-count">
            {{ review.vote_sum }}
          </span>
        </p>
        <button class="vote-btn btn btn-sm btn-light" data-value="1" title="–õ–∞–π–∫">üëç</button>
        <button class="vote-btn btn btn-sm btn-light" data-value="-1" title="–î–∏–∑–ª–∞–π–∫">üëé</button>


        {% if user.is_authenticated %}
          <button
            type="button"
            class="new-comment-btn btn btn-xs btn-link"
            data-id="new-{{ review.id }}"
          >
            –û—Ç–≤–µ—Ç–∏—Ç—å
          </button>
          <form
            action="{% url 'add_comment' review.id %}"
            method="post"
            class="new-comment-form form-new-{{ review.id }}"
            style="display:none; margin-left:1.5em;"
          >
            {% csrf_token %}
            {{ comment_form.text }}
            <button type="submit" class="btn btn-primary btn-sm">
             –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
          </form>
        {% endif %}

        <div class="comments">
          {% for comment in review.comments.all %}
            {% if comment.parent is None %}
              <div class="comment" id="c-{{ comment.id }}">
                <p>
                  <strong>{{ comment.user.username }}</strong>
                  <small>{{ comment.created_at|timesince }} –Ω–∞–∑–∞–¥</small>
                </p>
                <p>{{ comment.text }}</p>

                {% for reply in comment.replies.all %}
                  <div class="reply" style="margin-left:2em; margin-top:0.5em;">
                    <p>
                      <strong>{{ reply.user.username }}</strong>
                      <small>{{ reply.created_at|timesince }} –Ω–∞–∑–∞–¥</small>
                    </p>
                    <p>{{ reply.text }}</p>
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          {% endfor %}
        </div>

      </div>
    <hr>
    {% empty %}
      <p>–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ—Ü–µ–Ω–∑–∏–π.</p>
    {% endfor %}
  </section>

  <section class="work-actions">
    {% if user.is_authenticated %}
      {% if in_list %}
        <a href="{% url 'toggle_list' work.pk %}"
           class="btn btn-secondary js-toggle-list">
          –£–¥–∞–ª–∏—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞
        </a>
      {% else %}
        <a href="{% url 'toggle_list' work.pk %}"
           class="btn btn-primary js-toggle-list">
          –î–æ–±–∞–≤–∏—Ç—å –≤ –º–æ–π —Å–ø–∏—Å–æ–∫
        </a>
      {% endif %}
    {% else %}
      <p><a href="{% url 'login' %}">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–ª—è—Ç—å –≤ ¬´–ú–æ–π —Å–ø–∏—Å–æ–∫¬ª.</p>
    {% endif %}
  </section>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {

  document.querySelectorAll('.js-toggle-list').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      fetch(this.href, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(r => r.json())
        .then(data => {
          if (data.in_list) {
            this.textContent = '–£–¥–∞–ª–∏—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞';
            this.classList.replace('btn-primary','btn-secondary');
          } else {
            this.textContent = '–î–æ–±–∞–≤–∏—Ç—å –≤ –º–æ–π —Å–ø–∏—Å–æ–∫';
            this.classList.replace('btn-secondary','btn-primary');
          }
        });
    });
  });


  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      document.cookie.split(';').forEach(c => {
        const cookie = c.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.slice(name.length+1));
        }
      });
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');


  document.querySelectorAll('.vote-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const div      = this.closest('.review');
      const reviewId = div.dataset.reviewId;
      const value    = this.dataset.value;

      fetch("{% url 'vote_review' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({ review: reviewId, value: value })
      })
      .then(r => r.json())
      .then(data => {
        if (data.score !== undefined) {
          div.querySelector('.vote-count').textContent = data.score;
        }
      });
    });
  });


  document.querySelectorAll('.new-comment-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id   = btn.dataset.id.replace('new-', '');
      const form = document.querySelector('.form-new-' + id);
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
    });
  });


  document.querySelectorAll('.reply-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id   = btn.dataset.id;
      const form = document.querySelector('.rform-' + id);
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
    });
  });
});
</script>
{% endblock %}
